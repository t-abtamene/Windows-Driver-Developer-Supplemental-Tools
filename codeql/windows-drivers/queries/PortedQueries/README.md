# A Repo for ported Code Analysis checks

This repository contains a set of CodeQL queries that are used to perform static analysis on drivers and other C/C++ codebases.

## Repo structure

- PortedQueries
    - Analysis Files
        - DispatchAnnotationMissing.sarif
        - ...
    - KMDFTestTemplate
        - KMDFTestTemplate.vcproj
        - ...
    - WDFTestingTemplate
        - WDFTestingTemplate.vcproj
        - ...
    - PortLibrary
        - Page.qll
        - ...
    - queries
        - DispatchAnnotationMissing
            - DispatchAnnotationMissing.ql
            - DispatchAnnotationMissing.qhelp
            - driver_snippet.c
        - query2 
        - ...
    - clean.cmd
    - analyze_inbox.cmd
    - analyze_wds.cmd
    - analyze_test.cmd
    - build_create_analyze_test.cmd

#### Analysis Files

* AnalysisFiles folder contains .sarif files. They are outputs of running CodeQL Analysis on test databases. The JSON property we look for in this files is the 'results' property. The value will be array of results of running a query. Each result object willl contain useful key-value pairs like line number and filename where an a result has occured.

* Analysis files for inbox drivers and WDS will be added if they have "results".

#### KMDFTestTemplate and WDFTestingTemplate

* These files are basic KMDF and WDF driver templates used for testing purposes. Each folder has an empty driver_snippet.c file which will be replaced by the appropriate test snippet at build time. Not all of the tests work this way, though. For convienience reason, some code snippets are added to the template file itself, like the case of PendingStatusError query's snippet, forexample. In such cases, the introduction of the buggy piece of code won't affect results of other queries. 

#### PortLibrary

* Contais .qll files for frequently used functions. 


#### queries

* Contains library for frequently used functions. 

#### queries

Each query directory contains 3 files. 

* a .qhelp files, which contains documentation for the query (use vscode for a nicer view),
* a .ql file which contains the query and 
* a .c driver_snippet file which will replace the driver_snippet.c file in the templates at build time. If it is not convinient to copy this snippet to the templates, the buggy code will be added to the template file, given that it won't interfere with other tests.

#### scripts

* build_create_analyze.cmd is used for building the template with the snippet code, creating databases, and running codeql analysis. For test samples only. 
* analyze_test.cmd is used to perform analysis only on test samples. 
* analyze_wds.cmd is used to perform analysis only on WDS. 
* analyze_inbox.cmd is used to perform analysis only on inbox drivers. 



## Getting Started

To run CodeQl quereis on source files, a query, a CodeQL CLI and a CodeQL CLI generated database are needed. 

### Development 

Detailed instruction on initial environment set up can be found here:
* [CodeQL development]( https://microsoft.sharepoint.com/teams/osg_core_sigma/dplat/_layouts/15/Doc.aspx?sourcedoc={0f6d196b-f967-4051-98f0-a5f723d95b59}&action=edit&wd=target%28SDAT.one%7Ca82b53b7-33c5-457b-b5a9-7901476954b3%2FCodeQL%20Development%7Cc38b6a51-81e2-441b-a2bc-5f0791c68838%2F%29&wdorigin=NavigationUrl)

The above link contains step-by-step guide to testing and CodeQL version requirement.

### Analysis
* [CodeQL analysis](https://microsoft.sharepoint.com/teams/osg_core_sigma/dplat/_layouts/15/Doc.aspx?sourcedoc={0f6d196b-f967-4051-98f0-a5f723d95b59}&action=edit&wd=target%28SDAT.one%7Ca82b53b7-33c5-457b-b5a9-7901476954b3%2FCodeQL%20Analysis%7C9f360dd7-6a8a-4d30-bf2d-74d35187f073%2F%29&wdorigin=NavigationUrl)

The above link contains information about how to run quereis or querysets against a database generated by CodeQL CLI.


### Dependencies

* This repository uses CodeQL version 2.6.3.

### Installing

CodeQL CLI can be downloaded from here: 

* [CodeQL CLI](https://github.com/github/codeql-cli-binaries/releases)

CodeQL language documentation for C/C++ can be found here: 

* [CodeQL doc](https://codeql.github.com/docs/ql-language-reference/)

When developing querires in VSCode, the CodeQL extension should be installed from VSCode marketplace. A SarifViewer extension will also be useful tabulate results of CodeQL analysis. 


### Executing program

* How to run the program

If msbuild is not in the env path, the run_all_tests.cmd script should be run in Developer Command Prompt Window of visual studio. One must also have to add the the codeql.exe path to environment variables to avoid going back and forth to the codeql directory to run codeql commands. The run_all_tests and run_only_analysis scripts assume that, but anyone can update the script to way they want. 

The two main codeql commands used in this project are create and analyse. A basic use of this commands is shown below:

* Creating Database from a source directory.

```
codeql database create                          //database creation command
-l=cpp                                          //language used
-c "msbuild /p:Platform=x64 /t:rebuild"         //build platform and target environment
"D:\TestDB\MyDB"                                //a destination for the database

```

* Running a query on the created database.

```
codeql database analyze                                     //analysis command  
"D:\TestDB\MyDB"                                            //database directory 
--format=sarifv2.1.0                                        //output format 
--output="AnalysisFiles\DispatchAnnotationMismatch.sarif"   //analysis output directory and file name
"queries\DispatchAnnotationMismatch.ql"                     //the path to a query file

```


## License

To Do.

## References

Links and other useful info
* [Windows-drivers-supplemental-tools](https://github.com/microsoft/Windows-Driver-Developer-Supplemental-Tools)
*  [Windows-driver-samples](https://github.com/Microsoft/Windows-driver-samples)
